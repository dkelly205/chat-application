<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>Chat Room</h2>

<div id="chatMessages" style="height:300px; overflow-y:scroll; border:1px solid #ccc;">
    <div th:each="msg : ${messages}">
        <b>User <span th:text="${msg.sender.id}"></span>:</b>
        <span th:text="${msg.content}"></span><br>
    </div>
</div>

<input type="text" id="messageInput" placeholder="Type a message" />
<button onclick="sendMessage()">Send</button>

<script th:inline="javascript">
    /*<![CDATA[*/
    var chatId = [[${chatId}]]; // Provided by Spring model
    var userId = [[${userId}]];

    var socket = new SockJS('/ws-chat');
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        stompClient.subscribe('/topic/chat.' + chatId, function(messageOutput) {

            console.log("Received message:", messageOutput);
            var msg = JSON.parse(messageOutput.body);
            var chatDiv = document.getElementById('chatMessages');
            chatDiv.innerHTML += '<b>User ' + msg.senderId + ':</b> ' + msg.content + '<br>';
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });
    });

    function sendMessage() {
        var content = document.getElementById('messageInput').value;
        if (content.trim() === '') return;

        stompClient.send("/app/chat.send", {}, JSON.stringify({
            chatId: chatId,
            senderId: userId,
            content: content
        }));

        document.getElementById('messageInput').value = '';
    }
    /*]]>*/
</script>
</body>
</html>